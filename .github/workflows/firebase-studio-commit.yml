name: Firebase Studio Commit

on:
  workflow_dispatch: {}
  repository_dispatch:
    types: [firebase-studio-update]

permissions:
  contents: write
  pull-requests: write

env:
  TARGET_BRANCH: main  # ← vaihda tarvittaessa (esim. master)

jobs:
  commit-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # Tee aina pieni muutos, jotta näet committiä syntyvän testissä
      - name: Apply change
        run: |
          mkdir -p tools
          echo "{\"updatedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > tools/firebase-studio-sync.json

      - name: Commit changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: Firebase Studio sync"

      - name: Push to default branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Pakota remote käyttämään tokenia
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git
          git push origin HEAD:$TARGET_BRANCH

      # --- PR-vaihtoehto (jos et halua suoraa pushia), poista yllä oleva Push-step ja käytä alla ---
      # - name: Create/checkout branch
      #   run: git checkout -B chore/firebase-studio-sync
      #
      # - name: Open PR
      #   uses: peter-evans/create-pull-request@v6
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     branch: chore/firebase-studio-sync
      #     title: "chore: Firebase Studio sync"
      #     body: "Automated sync from Firebase Studio"
      #     base: ${{ env.TARGET_BRANCH }}
